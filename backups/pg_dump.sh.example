#!/bin/sh
set -eu

: "${PGHOST:=db}"
: "${PGPORT:=5432}"
: "${PGUSER:=postgres}"
: "${PGPASSWORD:=postgres}"
: "${PGDATABASE:=postgres}"
: "${BACKUP_DIR:=/var/backups/postgres}"
: "${RETENTION_DAYS:=7}"
export PGPASSWORD

mkdir -p "$BACKUP_DIR"

# Wait for DB (30 * 2s = max 60s)
for i in $(seq 1 30); do
  if pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" >/dev/null 2>&1; then
    break
  fi
  echo "[$(date)] DB not ready... retry $i/30"
  sleep 2
done

STAMP="$(date +%F_%H-%M-%S)"
OUTFILE="${BACKUP_DIR}/${PGDATABASE}_${STAMP}.dump"

echo "[$(date)] Starting pg_dump -> ${OUTFILE}"
pg_dump -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -Fc -f "$OUTFILE"

# Retention
find "$BACKUP_DIR" -type f -mtime +${RETENTION_DAYS} -print -delete
echo "[$(date)] Backup done."
SH
chmod +x scripts/pg_backup.sh